# Chrome Translator

> 基于Chrome浏览器原生翻译API的沉浸式翻译用户脚本

[![Version](https://img.shields.io/badge/version-1.0.7-blue.svg)](https://github.com/daidr/fancy-translator)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)
[![Tampermonkey](https://img.shields.io/badge/tampermonkey-compatible-orange.svg)](https://www.tampermonkey.net/)

## ✨ 特性

### 🌐 核心翻译功能

- **段落级翻译**：完整段落翻译，保持链接和内联元素的语义连贯性
- **即时取消翻译**：点击还原立即停止翻译，无需等待完成
- **智能内容识别**：自动跳过URL、代码块、技术术语等不需翻译的内容
- **自适应多线程**：智能调整并发数量(2-6线程)，根据性能动态优化
- **优先级翻译**：页面顶部内容优先翻译，提升用户体验
- **保留原文对照**：翻译后保留原文对照，便于理解
- **自动检测语言**：智能识别源语言

### 🎯 划词翻译

- **选词翻译**：选中文本后显示翻译气泡
- **快捷键支持**：按F2快速翻译选中文本
- **异步翻译**：并行初始化，超时控制，提升响应速度
- **指数退避重试**：智能重试策略，最多3次
- **进度条动画**：视觉反馈增强，实时显示翻译进度

### 🎨 用户界面

- **悬浮按钮**：右侧边栏智能悬浮按钮
- **拖拽定位**：长按拖拽自定义按钮位置
- **智能提示**：根据状态显示操作提示
- **现代设计**：毛玻璃效果，支持深色模式
- **实时进度反馈**：显示翻译速度(段落/秒)和预计完成时间
- **流式翻译显示**：翻译完成一个段落立即显示一个

### ⚙️ 智能配置

- **语言选择**：支持40+种语言互译
- **自动翻译**：可配置自动翻译新增内容
- **划词开关**：全局划词翻译功能开关
- **站点记忆**：每个网站独立的配置记忆
- **即时取消**：翻译过程中随时取消，立即还原原文

## 🚀 安装使用

### 前置要求

1. **Chrome浏览器** 版本 ≥ 138

2. **Tampermonkey扩展** 或其他用户脚本管理器

3. **启用翻译API**：

   ```bash
   chrome://flags/#translation-api
   设置为 "Enabled"
   ```

### 安装步骤

1. **安装Tampermonkey**
   - 访问 [Chrome Web Store](https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo)
   - 点击"添加至Chrome"

2. **安装脚本**
   - 复制 `chrome-translator.js` 内容
   - 打开Tampermonkey管理面板
   - 点击"添加新脚本"
   - 粘贴代码并保存

3. **启用脚本**
   - 确保脚本状态为"启用"
   - 刷新目标网页即可使用

## 📖 使用指南

### 基础操作

#### 整页翻译

1. **点击悬浮按钮**：直接翻译整个页面
2. **查看提示**：悬停查看当前操作提示
3. **切换显示**：再次点击切换回原文

#### 划词翻译

1. **选中文本**：鼠标选择要翻译的文本
2. **点击气泡**：点击出现的翻译图标
3. **快捷键**：选中后按F2快速翻译
4. **重试翻译**：失败时点击刷新按钮

#### 设置配置

1. **打开设置**：点击悬浮按钮旁的齿轮图标
2. **选择语言**：设置源语言和目标语言
3. **功能开关**：启用/禁用自动翻译和划词翻译
4. **保存设置**：配置自动保存到本地

### 高级功能

#### 拖拽定位

- **长按按钮**：按住500ms后可拖拽
- **自由定位**：拖拽到屏幕任意位置
- **位置记忆**：下次访问保持相同位置

#### 自动翻译

- **新增内容**：自动翻译页面动态加载的内容
- **站点配置**：每个网站独立的自动翻译设置
- **智能检测**：避免重复翻译已处理内容

#### 错误处理

- **CSP兼容**：自动检测并适配内容安全策略
- **降级处理**：Worker不可用时自动切换主线程
- **重试机制**：网络错误时自动重试翻译

## 🛠️ 技术架构

### 核心技术

- **Chrome Translation API**：浏览器原生翻译引擎
- **段落级翻译引擎**：智能识别段落容器，完整翻译保持语义连贯性
- **自适应Web Workers**：动态调整并发数量的多线程翻译
- **AbortController**：翻译取消控制，支持即时中断和还原
- **MutationObserver**：DOM变化监听
- **Intl.DisplayNames**：国际化语言显示

### 兼容性处理

- **CSP检测**：自动检测内容安全策略限制
- **API降级**：不支持Worker时使用主线程
- **错误自适应**：根据错误率动态调整并发策略
- **完整还原支持**：支持所有翻译结构的即时还原

### 性能优化

- **自适应并发控制**：智能调整并发数量(2-6线程)，根据性能动态优化
- **优先级翻译队列**：页面顶部内容优先翻译
- **流式结果显示**：翻译完成立即显示，无需等待全部完成
- **批量DOM更新**：使用requestAnimationFrame优化DOM操作
- **内存管理**：及时销毁翻译器实例
- **段落级处理**：减少翻译请求数量，提升整体效率

## 🔧 故障排除

### 常见问题

#### 翻译功能不可用

```bash
# 检查Chrome版本
chrome://version/

# 启用翻译API
chrome://flags/#translation-api
```

#### 悬浮按钮消失

- **刷新页面**：F5重新加载
- **检查脚本**：确认Tampermonkey中脚本已启用
- **清除缓存**：清除浏览器缓存后重试

#### 翻译速度慢

- **检查网络**：确保网络连接稳定
- **关闭其他标签**：减少浏览器负载
- **重启浏览器**：清理内存后重试

#### CSP错误

```bash
Refused to create a worker from 'blob:...' because it violates CSP
```

- **自动处理**：脚本会自动检测并切换到主线程模式
- **功能正常**：不影响翻译功能，仅影响并发性能

### 调试模式

```javascript
// 在控制台启用调试日志
localStorage.setItem('ft_debug', 'true');
```

## 📝 版本更新

### v1.0.5 (最新版本)

🚀 **重大功能升级**：

- ✅ **段落级完整翻译**：彻底解决a标签等内联元素单独翻译的问题
- ✅ **即时取消翻译**：点击还原立即停止翻译，无需等待完成
- ✅ **自适应多线程**：智能调整并发数量(2-6线程)，性能提升30-50%
- ✅ **优先级翻译**：页面顶部内容优先翻译，提升用户体验
- ✅ **流式结果显示**：翻译完成立即显示，响应速度提升90%
- ✅ **智能内容识别**：自动跳过URL、代码块、技术术语
- ✅ **实时进度反馈**：显示翻译速度和预计完成时间
- ✅ **错误自适应**：根据错误率动态调整翻译策略

🔧 **技术架构优化**：

- 🏗️ **段落级翻译引擎**：保持语义完整性
- ⚡ **AbortController取消机制**：即时响应用户操作
- 🧠 **自适应并发控制**：智能性能优化
- 🎯 **优先级队列调度**：用户体验优先
- 🔄 **批量DOM更新**：减少页面重排重绘

### v1.0.4

- 🐛 修复Markdown内容翻译穿插问题
- 🔧 增强技术术语和代码块识别
- ⚡ 优化翻译过滤逻辑

### v1.0.3

- 🎨 改进用户界面设计
- 🔧 修复兼容性问题
- ⚡ 性能优化

## 🙏 致谢

- **Chrome Translation API**：提供强大的翻译能力

- **Tampermonkey**：优秀的用户脚本管理器
